<%= render 'layouts/admin_header' %>

<div class="container">
  <h3>注文履歴詳細</h3>
  <div class="row">
    <div class="col-xs-6">
      <table class="table">
        <tr>
          <td>購入者</td>
          <td>
            <%= @order.customer.last_name %><%= @order.customer.first_name %>
          </td>
        </tr>
        <tr>
          <td>配送先</td>
          <td><%= @order.address %></td>
        </tr>
        <tr>
          <td>支払方法</td>
          <td><%= @order.payment_method %></td>
        </tr>
        <tr>
          <td>注文ステータス</td>
          <td>
            <%= form_with model: @order, url: admins_order_path(@order), local:true do |f| %>
              <%= f.select :status, [["入金待ち", "入金待ち"], ["入金確認", "入金確認"], ["製作中", "製作中"], ["発送準備中", "発送準備中"], ["発送済み", "発送済み"]] %>
              <%= f.submit "更新", class: 'btn btn-primary' %>
            <% end %>
          </td>
        </tr>
      </table>
    </div>
  </div>
  <div class="row">
    <div class="col-xs-12">
      <div class="col-xs-8">
        <table class="table">
          <thead>
            <tr>
          	  <th>商品名</th>
          	  <th>単価（税込）</th>
          	  <th>数量</th>
          	  <th>小計</th>
           	  <th>製作ステータス</th>
            </tr>
          </thead>
          <tbody>
            <% @order.order_details.each do |order_detail| %>
              <tr>
                <td><%= order_detail.item.name %></td>
                <td>
                  <%= tax_included_price(order_detail.item.price) %>
                </td>
                <td><%= order_detail.amount %></td>
                <td>
                  <% tax_included_price = order_detail.item.price*1.1 %>
                  <% tax_included_price = tax_included_price.round(0) %>
                  <%= (tax_included_price*order_detail.amount).to_s(:delimited) %>
                </td>
                <td>
                  <%= form_with model: order_detail, url: admins_order_detail_path(order_detail), method: :patch, local:true do |f| %>
                    <%= f.select :making_status, [["製作不可", "製作不可"], ["製作待ち", "製作待ち"], ["製作中", "製作中"], ["製作完了", "製作完了"]] %>
                    <%= f.submit "更新", class: 'btn btn-primary' %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="col-xs-4">
        <table class="table">
          <tr>
            <td>商品合計</td>
            <% @sum = 0 %>
            <% @order.order_details.each do |order| %>
              <% price = order.item.price %>
              <% amount = order.amount %>
              <% @sum += price * amount %>
            <% end %>
            <td>
              <%= (@sum * 1.1).round.to_s(:delimited) %>
            </td>
          </tr>
          <tr>
            <td>送料</td>
            <td><%= @order.shipping_cost %></td>
          </tr>
          <tr>
            <td>請求金額合計</td>
            <% total_price = @order.shipping_cost + (@sum * 1.1) %>
            <td><%= total_price.round.to_s(:delimited) %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>
